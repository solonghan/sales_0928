(function($) {
    $.fn.keyboard = function(options) {
        var settings = $.extend({
            keyboardLayout: [
                [
                    ["1", "1"],
                    ["2", "2"],
                    ["3", "3"],
                    ["4", "4"],
                    ["5", "5"],
                    ["6", "6"],
                    ["7", "7"],
                    ["8", "8"],
                    ["9", "9"],
                    ["0", "0"],
                    ["del", "del"]
                ],
                [
                    ["q", "Q"],
                    ["w", "W"],
                    ["e", "E"],
                    ["r", "R"],
                    ["t", "T"],
                    ["y", "Y"],
                    ["u", "U"],
                    ["i", "I"],
                    ["o", "O"],
                    ["p", "P"],
                    ["-", "="],
                    ["_", "+"]
                ],
                [
                    ["a", "A"],
                    ["s", "S"],
                    ["d", "D"],
                    ["f", "F"],
                    ["g", "G"],
                    ["h", "H"],
                    ["j", "J"],
                    ["k", "K"],
                    ["l", "L"],
                    ["'", ":"],
                    ["@", ";"],
                    ["#", "~"]
                ],
                [
                    ["z", "Z"],
                    ["x", "X"],
                    ["c", "C"],
                    ["v", "V"],
                    ["b", "B"],
                    ["n", "N"],
                    ["m", "M"],
                    [",", ","],
                    [".", "."],
                    ["?", "!"]
                ],
                [
                    ["shift", "shift"],
                    ["space", "space"],
                    ["shift", "shift"]
                ]
            ],
            numpadLayout: [
                [
                    ["7"],
                    ["8"],
                    ["9"]
                ],
                [
                    ["4"],
                    ["5"],
                    ["6"]
                ],
                [
                    ["1"],
                    ["2"],
                    ["3"]
                ],
                [
                    ["del"],
                    ["0"],
                    ["OK"]
                ]
            ],
            telLayout: [
                [
                    ["1"],
                    ["2"],
                    ["3"]
                ],
                [
                    ["4"],
                    ["5"],
                    ["6"]
                ],
                [
                    ["7"],
                    ["8"],
                    ["9"]
                ],
                [
                    ["del"],
                    ["0"],
                    ["OK"]
                ]
            ],
            layout: false,
            type: false,
            btnTpl: '<button type="button">',
            btnClasses: "btn btn-default",
            btnActiveClasses: "active btn-primary",
            initCaps: false
        }, options);
        // settings.type = $(this).attr("type");
        if (!settings.layout) {
            if (($(this).attr("type") === "tel" && $(this).hasClass("keyboard-numpad")) || settings.type === "numpad") {
                settings.layout = settings.numpadLayout;
            } else {
                if (($(this).attr("type") === "tel") || settings.type === "tel") {
                    settings.layout = settings.telLayout
                } else {
                    settings.layout = settings.keyboardLayout
                }
            }
        }
        var keyboardShift = false;
        $(document).off("touchstart mousedown", ".jqbtk-row .btn");
        $(document).on("touchstart mousedown", ".jqbtk-row .btn", function(e) {
            $(this).addClass(settings.btnActiveClasses);
            var keyContent = $(this).attr("data-value" + (keyboardShift ? "-alt" : ""));
            var parent = $("[aria-describedby=" + $(this).closest(".popover").attr("id") + "]");
            var currentContent = parent.val().replace("其它", "").replace("人", "");
            switch (keyContent) {
                case "space":
                    currentContent += " ";
                    break;
                case "shift":
                    keyboardShift = !keyboardShift;
                    keyboardShiftify();
                    break;
                case "del":
                    currentContent = currentContent.substr(0, currentContent.length - 1);
                    break;
                case "OK":
                    $(".popover").popover("hide");
                    break;
                default:
                    currentContent += keyContent;
                    keyboardShift = false
            }

            // if ($(this).hasClass('numberpad')) {
            //     if (currentContent == "") {
            //         parent.val("其它");    
            //     }else{
            //         parent.val(currentContent+"人");
            //     }
            // }else{
            //     parent.val(currentContent);
            // }
            parent.val(currentContent);
            
            // parent.val(currentContent+" "+settings.type);
            
            keyboardShiftify();
            parent.focus()
        });
        $(document).on("touchend mouseup", ".jqbtk-row .btn", function() {
            $(this).removeClass(settings.btnActiveClasses)
        });
        $(document).on("touchstart mousedown", ".jqbtk-row", function(e) {
            e.preventDefault();
            var parent = $("[aria-describedby=" + $(this).closest(".popover").attr("id") + "]");
            parent.focus()
        });
        $(document).on("touchend mouseup", ".modal:not(.popover)", function(e) {
            $(".popover").popover('hide');
        });
        var keyboardShiftify = function() {
            $(".jqbtk-container .btn").each(function() {
                switch ($(this).attr("data-value")) {
                    case "shift":
                    case "del":
                    case "space":
                    case "OK":
                        break;
                    default:
                        $(this).text($(this).attr("data-value" + (keyboardShift ? "-alt" : "")))
                }
            })
        };
        return this.each(function() {
            $(this).popover({
                content: function() {
                    if (settings.initCaps && $(this).val().length === 0) {
                        keyboardShift = true
                    }
                    $(this).val("");
                    var content = $('<div class="jqbtk-container">');
                    $.each(settings.layout, function() {
                        var line = this;
                        var lineContent = $('<div class="jqbtk-row">');
                        $.each(line, function() {
                            var btn = $(settings.btnTpl).addClass(settings.btnClasses);
                            btn.attr("data-value", this[0]).attr("data-value-alt", this[1]);
                            switch (this[0]) {
                                case "shift":
                                    btn.addClass("jqbtk-shift").html('<span class="glyphicon glyphicon-arrow-up"></span>');
                                    break;
                                case "space":
                                    btn.addClass("jqbtk-space").html("&nbsp;");
                                    break;
                                case "del":
                                    btn.addClass("jqbtk-del").html('<span class="glyphicon glyphicon-arrow-left"></span>');
                                    break;
                                case "OK":
                                    btn.addClass("jqbtk-ok").html('<span class="glyphicon glyphicon-ok"></span>');
                                    break;
                                default:
                                    btn.text(btn.attr("data-value" + (keyboardShift ? "-alt" : "")))
                            }
                            lineContent.append(btn)
                        });
                        content.append(lineContent)
                    });
                    return content
                },
                html: true,
                placement: "bottom",
                trigger: "click",
                container: "body",
                viewport: "body"
            })
        })
    }
}(jQuery));
	
